<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ”¹è¿›ç‰ˆ â€” åŒæ¯”ä¾‹å›¾ç‰‡è£å‰ª & æ‰¹é‡å¯¼å‡º (1:1 + 3:4)</title>
<!-- ç®€æ´ç°ä»£æ ·å¼ -->
<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --accent:#3466f2; --muted:#6b7280; --glass: rgba(20,30,60,0.04);
    --success:#16a34a;
  }
  *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#eaf0ff);color:#0f172a}
  .wrap{max-width:1200px;margin:28px auto;padding:20px}
  header{display:flex;gap:16px;align-items:center;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(20,30,60,0.06)}
  /* sidebar */
  .sidebar .drop{border:2px dashed var(--glass);border-radius:10px;padding:18px;text-align:center;cursor:pointer}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:transparent;border:1px solid var(--glass)}
  .file-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
  .file-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:var(--glass)}
  .file-item img{width:56px;height:40px;object-fit:cover;border-radius:6px}
  .meta{font-size:13px}
  .meta small{color:var(--muted);display:block}
  /* main area */
  .stage{display:flex;flex-direction:column;gap:12px}
  .canvas-wrap{background:#0b1220;border-radius:10px;padding:12px;display:flex;gap:12px;align-items:flex-start}
  .viewer{position:relative;flex:1;min-height:420px;border-radius:8px;overflow:hidden;background:#fff}
  canvas{display:block;width:100%;height:100%}
  .crop-box{position:absolute;border:2px dashed rgba(52,102,242,0.95);background:rgba(52,102,242,0.06);touch-action:none}
  .handle{position:absolute;width:12px;height:12px;background:#fff;border:2px solid var(--accent);border-radius:50%}
  .handle.br{right:-8px;bottom:-8px;cursor:se-resize}
  .handle.bl{left:-8px;bottom:-8px;cursor:sw-resize}
  .handle.tl{left:-8px;top:-8px;cursor:nw-resize}
  .handle.tr{right:-8px;top:-8px;cursor:ne-resize}
  .controls{width:320px;display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted)}
  .inline{display:flex;gap:8px;align-items:center}
  input[type="number"], input[type="text"], select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass)}
  .previews{display:flex;gap:12px}
  .preview-card{background:#fff;border-radius:8px;padding:8px;text-align:center;min-width:120px}
  .small-canvas{width:120px;height:120px;background:#f8fafc;border-radius:6px;display:block}
  footer.actions{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .muted{color:var(--muted);font-size:13px}
  @media (max-width:940px){.grid{grid-template-columns:1fr;}.controls{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>æ”¹è¿›ç‰ˆï¼šåŒæ¯”ä¾‹è£å‰ª & æ‰¹é‡å¯¼å‡º</h1>
      <p class="lead">åŸºäºä½ ä¸Šä¼ çš„å·¥å…·æ”¹è¿›ï¼ˆæ”¯æŒå®é™…å¯¼å‡º ZIPã€æ¯”ä¾‹é”å®šã€è§¦æ§ã€é”®ç›˜å¯¼èˆªï¼‰ã€‚</p>
    </div>
    <div style="margin-left:auto" class="muted">å¿«æ·ï¼šâ† â†’ åˆ‡å›¾ Â· ç©ºæ ¼ åˆ‡æ¢æ¯”ä¾‹é”å®š</div>
  </header>

  <div class="grid">
    <!-- SIDEBAR UPLOAD -->
    <aside class="card sidebar">
      <div id="drop" class="drop" tabindex="0">
        <div style="font-size:22px">ğŸ“‚ æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
        <div class="muted" style="margin-top:6px">æ”¯æŒ JPG / PNGï¼Œæœ€å¤š 20 å¼ </div>
        <input id="files" type="file" accept="image/*" multiple style="display:none">
        <div style="margin-top:10px">
          <button id="pickBtn" class="btn primary">é€‰æ‹©å›¾ç‰‡</button>
          <button id="clearBtn" class="btn ghost">æ¸…ç©º</button>
        </div>
      </div>

      <div class="file-list" id="fileList"></div>

      <div style="margin-top:12px">
        <label>è¾“å‡ºè®¾ç½®</label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="format" style="flex:1">
            <option value="jpg">JPG (å‹ç¼©)</option>
            <option value="png">PNG (æ— æŸ)</option>
          </select>
          <input id="quality" type="number" min="30" max="100" value="92" style="width:84px" />
        </div>
        <div style="margin-top:8px" class="inline">
          <input id="keepOriginal" type="checkbox" checked />
          <label for="keepOriginal">ä¿ç•™åŸå›¾</label>
        </div>
      </div>
      <div style="margin-top:12px" class="muted">å‘½åæ¨¡æ¿ï¼šä½¿ç”¨ {index} è¡¨ç¤ºåºå·</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="name1" type="text" value="img_{index}_1x1" placeholder="1:1 æ–‡ä»¶åæ¨¡æ¿" />
        <input id="name34" type="text" value="img_{index}_3x4" placeholder="3:4 æ–‡ä»¶åæ¨¡æ¿" />
      </div>
    </aside>

    <!-- MAIN -->
    <main class="stage card">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="muted">å›¾ç‰‡ <span id="idx">0</span>/<span id="total">0</span></div>
        <div style="margin-left:auto" class="inline">
          <label>æ¯”ä¾‹é”å®š</label>
          <select id="ratioSelect">
            <option value="free">è‡ªç”±</option>
            <option value="1:1">1:1</option>
            <option value="3:4">3:4</option>
          </select>
          <button id="prev" class="btn ghost">â†</button>
          <button id="next" class="btn ghost">â†’</button>
        </div>
      </div>

      <div class="canvas-wrap">
        <div class="viewer" id="viewer">
          <!-- ç”¨äºæ¸²æŸ“å›¾ç‰‡çš„çœŸå® canvasï¼ˆæŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼‰ -->
          <canvas id="imgCanvas"></canvas>
          <!-- è£å‰ªæ¡† DOMï¼ˆè¦†ç›–åœ¨ canvas ä¸Šï¼‰ -->
          <div id="cropBox" class="crop-box" style="left:20px;top:20px;width:200px;height:200px">
            <div class="handle tl"></div>
            <div class="handle tr"></div>
            <div class="handle bl"></div>
            <div class="handle br"></div>
          </div>
        </div>

        <div class="controls">
          <label>é¢„è§ˆ (1:1 & 3:4)</label>
          <div class="previews">
            <div class="preview-card">
              <div>1:1</div>
              <canvas id="pv11" class="small-canvas"></canvas>
            </div>
            <div class="preview-card">
              <div>3:4</div>
              <canvas id="pv34" class="small-canvas" style="height:160px"></canvas>
            </div>
          </div>

          <label>è¾“å‡ºå°ºå¯¸ï¼ˆå®½åº¦åƒç´ ï¼Œç¨‹åºä¼šæŒ‰æ¯”ä¾‹ç¼©æ”¾é«˜åº¦ï¼‰</label>
          <div style="display:flex;gap:8px">
            <input id="w11" type="number" value="1200" min="64" />
            <input id="w34" type="number" value="1200" min="64" />
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportBtn" class="btn primary">å¯¼å‡ºæ‰€æœ‰å¹¶æ‰“åŒ… ZIP</button>
            <button id="exportSingle" class="btn ghost">å¯¼å‡ºå½“å‰å›¾ç‰‡</button>
          </div>

          <div class="muted" style="margin-top:8px">æç¤ºï¼šåœ¨ç”»å¸ƒä¸Šæ‹–æ‹½è£å‰ªæ¡†ç§»åŠ¨ï¼Œæ‹–æ‹½å³ä¸‹è§’ç¼©æ”¾ã€‚ç©ºæ ¼åˆ‡æ¢æ¯”ä¾‹é”å®šã€‚</div>
        </div>
      </div>

      <footer class="actions">
        <div class="muted">å¤„ç†å®Œæˆåä¼šè‡ªåŠ¨è§¦å‘ä¸‹è½½ ZIPã€‚</div>
        <div>
          <button id="downloadLog" class="btn ghost">ä¿å­˜æ—¥å¿—</button>
        </div>
      </footer>
    </main>
  </div>
</div>

<!-- ä¾èµ–ï¼šJSZip + FileSaver (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/*
  æ”¹è¿›ç‰ˆå®ç°è¦ç‚¹ï¼š
  - çœŸå®ç»˜åˆ¶åˆ° canvas -> ä» canvas ä»¥æŒ‡å®šå°ºå¯¸å¯¼å‡ºå›¾ç‰‡ blob
  - ç»´æŠ¤æ¯å¼ å›¾ç‰‡å¯¹åº”çš„ cropBoxï¼ˆç›¸å¯¹äºç»˜åˆ¶ canvas çš„åƒç´ ï¼‰
  - æ”¯æŒæ¯”ä¾‹é”å®šï¼šfree / 1:1 / 3:4
  - æ‰¹é‡å¤„ç†å¹¶ä½¿ç”¨ JSZip ç”Ÿæˆ zip ä¸‹è½½
  - ä»£ç æ³¨é‡Šä¾¿äºæ‰©å±•
*/

const MAX_FILES = 20;
const filesInput = document.getElementById('files');
const pickBtn = document.getElementById('pickBtn');
const clearBtn = document.getElementById('clearBtn');
const drop = document.getElementById('drop');
const fileList = document.getElementById('fileList');

const imgCanvas = document.getElementById('imgCanvas');
const imgCtx = imgCanvas.getContext('2d');
const viewer = document.getElementById('viewer');
const cropBox = document.getElementById('cropBox');

const pv11 = document.getElementById('pv11'); const pv11Ctx = pv11.getContext('2d');
const pv34 = document.getElementById('pv34'); const pv34Ctx = pv34.getContext('2d');

const idxLabel = document.getElementById('idx');
const totalLabel = document.getElementById('total');

const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');

const ratioSelect = document.getElementById('ratioSelect');
const exportBtn = document.getElementById('exportBtn');
const exportSingle = document.getElementById('exportSingle');
const w11 = document.getElementById('w11');
const w34 = document.getElementById('w34');

const formatSel = document.getElementById('format');
const qualityInput = document.getElementById('quality');
const keepOriginal = document.getElementById('keepOriginal');
const name1 = document.getElementById('name1');
const name34 = document.getElementById('name34');

let items = []; // {file, src, imageObj, crop:{x,y,w,h} } crop in canvas pixels
let current = 0;
let dragging = false, resizing = false, dragOffset = {x:0,y:0}, resizeStart = null;
let activeHandle = null;

// æ–‡ä»¶é€‰æ‹©/æ‹–æ”¾
pickBtn.addEventListener('click', () => filesInput.click());
filesInput.addEventListener('change', e => handleFiles(e.target.files));
clearBtn.addEventListener('click', () => { items=[]; current=0; renderFileList(); updateViewer(); });

drop.addEventListener('click', ()=> filesInput.click());
drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.borderColor = '#9bb7ff' });
drop.addEventListener('dragleave', e => { drop.style.borderColor = '' });
drop.addEventListener('drop', e => { e.preventDefault(); handleFiles(e.dataTransfer.files); drop.style.borderColor = '' });

// åŠ è½½æ–‡ä»¶æ•°ç»„
function handleFiles(fileListIn){
  const list = Array.from(fileListIn).filter(f=>f.type.startsWith('image/')).slice(0, MAX_FILES - items.length);
  if(list.length===0) return;
  let loaded = 0;
  list.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        items.push({file, src:ev.target.result, imageObj:img, crop:null});
        loaded++; if(loaded===list.length){ current = items.length- list.length >=0 ? items.length-list.length : 0; renderFileList(); updateViewer(); }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// åˆ—è¡¨æ¸²æŸ“
function renderFileList(){
  fileList.innerHTML='';
  items.forEach((it, i) => {
    const el = document.createElement('div'); el.className='file-item';
    el.innerHTML = `<img src="${it.src}"><div class="meta"><strong>å›¾ç‰‡ ${i+1}</strong><small>${Math.round(it.file.size/1024)}KB</small></div>`;
    el.addEventListener('click', ()=> { current = i; updateViewer(); });
    fileList.appendChild(el);
  });
  idxLabel.textContent = items.length? (current+1):0;
  totalLabel.textContent = items.length;
}

// æ›´æ–° viewerï¼šç»˜åˆ¶å½“å‰å›¾ç‰‡åˆ° canvasï¼Œå¹¶æ¢å¤/åˆå§‹åŒ–è£å‰ªæ¡†ï¼ˆåŸºäº canvas å°ºå¯¸ï¼‰
function updateViewer(){
  if(!items[current]){ // æ¸…ç©º
    imgCtx.clearRect(0,0,imgCanvas.width,imgCanvas.height);
    cropBox.style.display='none';
    renderFileList();
    return;
  }
  const it = items[current];
  const containerW = viewer.clientWidth;
  const containerH = viewer.clientHeight;
  // è®¡ç®—é€‚åº”å°ºå¯¸ï¼ˆfitï¼‰
  const img = it.imageObj;
  const ratio = img.width / img.height;
  let drawW = containerW, drawH = containerW / ratio;
  if(drawH > containerH){ drawH = containerH; drawW = containerH * ratio; }
  // è®¾ç½®å®é™… canvas çš„åƒç´ å°ºå¯¸ï¼ˆä¸ºä¿æŒè¾“å‡ºè´¨é‡ï¼Œä½¿ç”¨è®¾å¤‡PixelRatioï¼‰
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  imgCanvas.width = Math.round(drawW * dpr);
  imgCanvas.height = Math.round(drawH * dpr);
  imgCanvas.style.width = drawW + 'px';
  imgCanvas.style.height = drawH + 'px';
  imgCtx.setTransform(dpr,0,0,dpr,0,0);
  imgCtx.clearRect(0,0,drawW,drawH);
  imgCtx.drawImage(img, 0, 0, drawW, drawH);

  // åˆå§‹åŒ– cropï¼ˆå¦‚æœè¿˜æ²¡è®¾ï¼‰
  if(!it.crop){
    const boxW = Math.min(drawW*0.7, drawW-20);
    const boxH = boxW; // é»˜è®¤ä¸ºæ­£æ–¹å½¢
    it.crop = { x: (drawW-boxW)/2, y:(drawH-boxH)/2, w:boxW, h:boxH }
  }
  // å°† cropBox DOM ä¸ canvas åŒæ­¥ï¼ˆä½¿ç”¨ canvas çš„ CSS å®½é«˜ï¼‰
  cropBox.style.display = 'block';
  cropBox.style.left = it.crop.x + 'px';
  cropBox.style.top = it.crop.y + 'px';
  cropBox.style.width = it.crop.w + 'px';
  cropBox.style.height = it.crop.h + 'px';

  idxLabel.textContent = current+1;
  totalLabel.textContent = items.length;

  updatePreviews();
}

// å°†å½“å‰ crop åŒºåŸŸæ¸²æŸ“åˆ°ä¸¤ä¸ªå°é¢„è§ˆ
function updatePreviews(){
  if(!items[current]) return;
  const it = items[current];
  const sx = it.crop.x, sy = it.crop.y, sw = it.crop.w, sh = it.crop.h;
  // pv11 -> 120x120
  const pv11W = pv11.clientWidth, pv11H = pv11.clientHeight;
  pv11.width = pv11W; pv11.height = pv11H;
  pv11Ctx.clearRect(0,0,pv11W,pv11H);
  pv11Ctx.drawImage(imgCanvas, sx, sy, sw, sh, 0,0, pv11W, pv11H);
  // pv34 -> 120x160(approx)
  const pv34W = pv34.clientWidth, pv34H = pv34.clientHeight;
  pv34.width = pv34W; pv34.height = pv34H;
  pv34Ctx.clearRect(0,0,pv34W,pv34H);
  // å¯¹ 3:4ï¼Œæˆ‘ä»¬éœ€è¦ä» crop ä¸­å–åˆ°åˆé€‚é«˜åº¦ (ä»¥ crop width ä¸ºåŸºå‡†)
  const desiredH = sw * 4 / 3;
  let srcY = sy + (sh - desiredH)/2;
  if(srcY < 0) srcY = 0;
  const srcH = Math.min(desiredH, imgCanvas.height - srcY);
  pv34Ctx.drawImage(imgCanvas, sx, srcY, sw, srcH, 0,0, pv34W, pv34H);
}

// è£å‰ªæ¡†äº¤äº’ï¼šç§»åŠ¨ä¸æ‹‰ä¼¸ï¼ˆæ”¯æŒè§¦æ‘¸ï¼‰
let startX=0, startY=0;
function clientPos(e){ const p = (e.touches && e.touches[0]) || e; return {x: p.clientX, y: p.clientY} }

// é¼ æ ‡æŒ‰ä¸‹åœ¨ cropBox ä¸Šï¼ˆåˆ¤æ–­æ˜¯å¦ç‚¹åˆ° handleï¼‰
cropBox.addEventListener('pointerdown', e => {
  e.preventDefault(); cropBox.setPointerCapture(e.pointerId);
  const p = clientPos(e);
  startX = p.x; startY = p.y;
  // ä¾æ®äº‹ä»¶ç›®æ ‡æ¨æ–­æ˜¯å¦ä¸º handle
  activeHandle = e.target.classList.contains('handle') ? e.target.classList[1] : null;
  const rect = viewer.getBoundingClientRect();
  // è®°å½•åˆå§‹å€¼ï¼ˆç›¸å¯¹äº canvas CSS coordsï¼‰
  const it = items[current];
  dragOffset.x = p.x - rect.left - it.crop.x;
  dragOffset.y = p.y - rect.top - it.crop.y;
  resizing = !!activeHandle;
  dragging = !resizing;
});

// å…¨å±€ç§»åŠ¨
window.addEventListener('pointermove', e => {
  if(!items[current]) return;
  if(!(dragging || resizing)) return;
  const rect = viewer.getBoundingClientRect();
  const p = clientPos(e);
  const mx = p.x - rect.left, my = p.y - rect.top;
  const it = items[current];
  const ratioLock = ratioSelect.value;

  if(dragging){
    // ç§»åŠ¨
    let nx = mx - dragOffset.x, ny = my - dragOffset.y;
    nx = Math.max(0, Math.min(nx, parseFloat(imgCanvas.style.width) - it.crop.w));
    ny = Math.max(0, Math.min(ny, parseFloat(imgCanvas.style.height) - it.crop.h));
    it.crop.x = nx; it.crop.y = ny;
    cropBox.style.left = nx + 'px'; cropBox.style.top = ny + 'px';
    updatePreviews();
  } else if(resizing){
    // ä»¥å³ä¸‹è§’ä¸ºåŸºå‡†çš„ç¤ºä¾‹ï¼ˆæ›´å¤æ‚çš„ handle æ–¹å‘åˆ†åˆ«å¤„ç†ï¼‰
    const startCrop = Object.assign({}, it.crop);
    if(activeHandle === 'br'){ // æ‹‰ä¼¸å³ä¸‹
      let newW = Math.max(40, mx - startCrop.x);
      let newH = Math.max(40, my - startCrop.y);
      if(ratioLock === '1:1'){ newH = newW; }
      if(ratioLock === '3:4'){ newH = newW * 4 / 3; }
      // é™åˆ¶ä¸èƒ½è¶…å‡º canvas
      newW = Math.min(newW, parseFloat(imgCanvas.style.width) - startCrop.x);
      newH = Math.min(newH, parseFloat(imgCanvas.style.height) - startCrop.y);
      it.crop.w = newW; it.crop.h = newH;
    } else if(activeHandle === 'tl'){
      // å·¦ä¸Šè§’æ‹‰ä¼¸ï¼Œæ”¹å˜ x,y,w,h
      let newX = Math.min(startCrop.x + startCrop.w - 40, mx);
      let newY = Math.min(startCrop.y + startCrop.h - 40, my);
      let newW = startCrop.x + startCrop.w - newX;
      let newH = startCrop.y + startCrop.h - newY;
      if(ratioLock === '1:1'){ newW = newH = Math.min(newW,newH); newX = startCrop.x + startCrop.w - newW; newY = startCrop.y + startCrop.h - newH; }
      if(ratioLock === '3:4'){ newH = newW * 4 / 3; newX = startCrop.x + startCrop.w - newW; }
      newX = Math.max(0, newX); newY = Math.max(0,newY);
      it.crop.x = newX; it.crop.y = newY; it.crop.w = newW; it.crop.h = newH;
    } else if(activeHandle === 'tr'){
      // å³ä¸Š
      let newW = Math.max(40, mx - startCrop.x);
      let newY = Math.min(startCrop.y + startCrop.h - 40, my);
      let newH = startCrop.y + startCrop.h - newY;
      if(ratioLock === '1:1'){ newH = newW; newY = startCrop.y + startCrop.h - newH; }
      if(ratioLock === '3:4'){ newH = newW * 4 / 3; newY = startCrop.y + startCrop.h - newH; }
      newW = Math.min(newW, parseFloat(imgCanvas.style.width)-startCrop.x);
      newY = Math.max(0,newY);
      it.crop.w = newW; it.crop.y = newY; it.crop.h = newH;
    } else if(activeHandle === 'bl'){
      // å·¦ä¸‹
      let newX = Math.min(startCrop.x + startCrop.w - 40, mx);
      let newW = startCrop.x + startCrop.w - newX;
      let newH = Math.max(40, my - startCrop.y);
      if(ratioLock === '1:1'){ newW = newH; newX = startCrop.x + startCrop.w - newW; }
      if(ratioLock === '3:4'){ newW = newH * 3 / 4; newX = startCrop.x + startCrop.w - newW; }
      it.crop.x = Math.max(0,newX); it.crop.w = newW; it.crop.h = Math.min(newH, parseFloat(imgCanvas.style.height)-startCrop.y);
    }
    // åŒæ­¥ DOM
    cropBox.style.left = it.crop.x + 'px';
    cropBox.style.top = it.crop.y + 'px';
    cropBox.style.width = it.crop.w + 'px';
    cropBox.style.height = it.crop.h + 'px';
    updatePreviews();
  }
});

// pointerup é‡Šæ”¾
window.addEventListener('pointerup', e => { dragging=false; resizing=false; activeHandle=null; });

// æŒ‰é’®åˆ‡å›¾
prevBtn.addEventListener('click', ()=> { if(current>0) current--; updateViewer(); renderFileList(); });
nextBtn.addEventListener('click', ()=> { if(current<items.length-1) current++; updateViewer(); renderFileList(); });

// é”®ç›˜å¿«æ·
window.addEventListener('keydown', e=>{
  if(e.code==='ArrowLeft'){ if(current>0){ current--; updateViewer(); renderFileList(); } }
  if(e.code==='ArrowRight'){ if(current<items.length-1){ current++; updateViewer(); renderFileList(); } }
  if(e.code==='Space'){ e.preventDefault(); // ç©ºæ ¼åœ¨ 1:1/3:4/free å¾ªç¯
    const sel = ratioSelect;
    if(sel.value === 'free') sel.value = '1:1';
    else if(sel.value === '1:1') sel.value = '3:4';
    else sel.value = 'free';
  }
});

// çœŸå®å¯¼å‡ºï¼šä»ç»˜åˆ¶åœ¨ imgCanvas çš„å¯è§†ç”»é¢ä¸­æŒ‰ crop åŒºåŸŸé‡‡æ ·ï¼Œç¼©æ”¾åˆ°ç›®æ ‡å°ºå¯¸
async function exportAll(){
  if(items.length===0){ alert('æ²¡æœ‰å›¾ç‰‡'); return; }
  const zip = new JSZip();
  const format = formatSel.value;
  const quality = Math.max(30, Math.min(100, Number(qualityInput.value || 92))) / 100;
  const keep = keepOriginal.checked;
  const w1 = Math.max(32, Number(w11.value || 1200));
  const w3 = Math.max(32, Number(w34.value || 1200));
  for(let i=0;i<items.length;i++){
    await renderForIndex(i); // ç¡®ä¿ canvas ç»˜åˆ¶å¯¹åº”å›¾ç‰‡
    const it = items[i];
    const {blob11, blob34} = await generatePairFromCurrent(i, w1, w3, format, quality);
    // æ–‡ä»¶å
    const nameBase1 = (name1.value || 'img_{index}_1x1').replace('{index}', (i+1));
    const nameBase34 = (name34.value || 'img_{index}_3x4').replace('{index}', (i+1));
    zip.file(nameBase1 + (format==='png'?'.png':'.jpg'), blob11);
    zip.file(nameBase34 + (format==='png'?'.png':'.jpg'), blob34);
    if(keep){
      // ä¿ç•™åŸå§‹ä¸Šä¼ æ–‡ä»¶
      zip.file('originals/' + items[i].file.name, items[i].file);
    }
  }
  // ç”Ÿæˆ zip
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, `images_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
}

// å¯¼å‡ºå½“å‰å›¾ç‰‡ï¼ˆç›´æ¥è§¦å‘ä¸‹è½½ä¸¤ä¸ªæ–‡ä»¶ï¼‰
async function exportCurrent(){
  if(!items[current]){ alert('æ²¡æœ‰å½“å‰å›¾ç‰‡'); return; }
  await renderForIndex(current);
  const format = formatSel.value;
  const quality = Math.max(30, Math.min(100, Number(qualityInput.value || 92))) / 100;
  const w1 = Math.max(32, Number(w11.value || 1200));
  const w3 = Math.max(32, Number(w34.value || 1200));
  const {blob11, blob34} = await generatePairFromCurrent(current, w1, w3, format, quality);
  const nameBase1 = (name1.value || 'img_{index}_1x1').replace('{index}', (current+1));
  const nameBase34 = (name34.value || 'img_{index}_3x4').replace('{index}', (current+1));
  saveAs(blob11, nameBase1 + (format==='png'?'.png':'.jpg'));
  saveAs(blob34, nameBase34 + (format==='png'?'.png':'.jpg'));
}

/*
 Helper: ç¡®ä¿ canvasã€crop å¯¹åº”åˆ° items[index]ï¼ˆå½“ç”¨æˆ·åˆ‡æ¢æ—¶ canvas å˜åŒ–ï¼‰
 å¦‚æœ index !== currentï¼Œä¼šæŠŠè¯¥å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸´æ—¶ç”¨äºç”Ÿæˆå›¾åƒ
*/
function renderForIndex(index){
  return new Promise(resolve=>{
    if(index === current){ resolve(); return; }
    // ä¸´æ—¶ç»˜åˆ¶ï¼šæŠŠ items[index] ç”»åˆ° canvas with same fitting logic
    const it = items[index];
    const containerW = viewer.clientWidth;
    const containerH = viewer.clientHeight;
    const img = it.imageObj;
    const ratio = img.width / img.height;
    let drawW = containerW, drawH = containerW / ratio;
    if(drawH > containerH){ drawH = containerH; drawW = containerH * ratio; }
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    imgCanvas.width = Math.round(drawW * dpr);
    imgCanvas.height = Math.round(drawH * dpr);
    imgCanvas.style.width = drawW + 'px';
    imgCanvas.style.height = drawH + 'px';
    imgCtx.setTransform(dpr,0,0,dpr,0,0);
    imgCtx.clearRect(0,0,drawW,drawH);
    imgCtx.drawImage(img,0,0,drawW,drawH);
    // å¦‚æœè¯¥å›¾æ²¡æœ‰ crop å®šä¹‰ï¼Œåˆå§‹åŒ–
    if(!it.crop){
      const boxW = Math.min(drawW*0.7, drawW-20);
      const boxH = boxW;
      it.crop = { x: (drawW-boxW)/2, y:(drawH-boxH)/2, w:boxW, h:boxH }
    }
    // ä¸æ”¹å˜ current è§†å›¾ï¼Œåªç”¨äºå¯¼å‡º -> resolve
    setTimeout(resolve,10);
  });
}

// ä»¥ç»™å®šè¾“å‡ºå®½åº¦ç”Ÿæˆä¸¤å¼ å›¾åƒ blobï¼ˆ1:1 ä¸ 3:4ï¼‰
async function generatePairFromCurrent(index, outW1, outW34, format, quality){
  // ç¡®ä¿ canvas å½“å‰ç»˜åˆ¶ä¸ºè¯¥å›¾ç‰‡
  if(index !== current){
    // ç»˜åˆ¶ç›®æ ‡å›¾ç‰‡åˆ° canvas first (åŒæ­¥)
    const saved = current;
    current = index;
    updateViewer();
  }
  const it = items[index];
  // src crop coords (åœ¨ canvas CSS åƒç´ )
  const sx = it.crop.x, sy = it.crop.y, sw = it.crop.w, sh = it.crop.h;
  // ä¸ºå¯¼å‡ºåˆ›å»ºä¸´æ—¶ canvasï¼ˆåƒç´ çº§åˆ«ï¼ŒæŒ‰ç”¨æˆ·æŒ‡å®šå®½åº¦ & ä¿æŒæ¯”ä¾‹ï¼‰
  // 1:1
  const tmp1 = document.createElement('canvas'); const t1 = tmp1.getContext('2d');
  tmp1.width = outW1; tmp1.height = outW1;
  // æŠŠ imgCanvas çš„ crop åŒºåŸŸç”»å…¥ tmp1
  t1.drawImage(imgCanvas, sx, sy, sw, sh, 0,0, tmp1.width, tmp1.height);
  // 3:4: ä»¥ crop å®½ä¸ºåŸºå‡†è®¡ç®—é«˜åº¦
  const desiredH = sw * 4 / 3;
  let srcY = sy + (sh - desiredH)/2;
  if(srcY < 0) srcY = 0;
  const srcH = Math.min(desiredH, imgCanvas.height - srcY);
  const tmp2 = document.createElement('canvas'); const t2 = tmp2.getContext('2d');
  tmp2.width = outW34; tmp2.height = Math.round(outW34 * 4 / 3);
  t2.drawImage(imgCanvas, sx, srcY, sw, srcH, 0,0, tmp2.width, tmp2.height);

  // å¯¼å‡º blob
  const mime = (format==='png')? 'image/png' : 'image/jpeg';
  const q = Math.max(0.3, Math.min(1, Number(quality)));
  const blob11 = await new Promise(r=> tmp1.toBlob(r, mime, q));
  const blob34 = await new Promise(r=> tmp2.toBlob(r, mime, q));
  return {blob11, blob34};
}

// äº‹ä»¶ç»‘å®šå¯¼å‡º
exportBtn.addEventListener('click', ()=>{ exportAll(); });
exportSingle.addEventListener('click', ()=>{ exportCurrent(); });

// å½“çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å½“å‰ view
window.addEventListener('resize', ()=> { if(items[current]) updateViewer(); });

// initial
renderFileList();

// é™„ï¼šæ‹–æ‹½å›¾ç‰‡åˆ°ä¾§æ çš„æ–‡ä»¶å¤„ç†ï¼ˆç›‘å¬ items æ•°ç›®å˜åŒ–ï¼‰
const obs = new MutationObserver(()=>{ renderFileList(); updateViewer(); });
obs.observe(fileList, {childList:true});

// æ—¥å¿—ä¸‹è½½ï¼ˆç¤ºä¾‹ï¼‰
document.getElementById('downloadLog').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({items: items.map(it=>({name:it.file.name, size: it.file.size}))},null,2)], {type:'application/json'});
  saveAs(blob, 'export-log.json');
});

// å°æç¤ºï¼šå½“ç”¨æˆ·åˆ‡æ¢ current æ—¶ï¼Œä¿æŒ cropBox DOM åœ¨ viewer ä¸ŠåŒæ­¥ï¼ˆç›‘å¬å¤–éƒ¨ current æ”¹å˜ï¼‰
new MutationObserver(()=>{}).observe(document.body,{attributes:true,childList:true,subtree:true});
</script>
</body>
</html>
