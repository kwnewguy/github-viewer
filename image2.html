<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片批量调宽 1400 - BatchResize</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: {
                850: '#151f32',
                900: '#0f172a',
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <style>
      body { background-color: #0f172a; color: #f8fafc; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react/dist/lucide-react.umd.js"></script>
    
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 全局变量提取 ---
        const { useState, useEffect, useCallback, useRef } = React;
        // 从全局对象中提取图标
        const { Trash2, Archive, Zap, ShieldCheck, Download, Upload, AlertCircle, CheckCircle2, Loader2, XCircle, FileImage } = lucideReact;

        // --- Utils: imageProcessor.ts ---
        const formatBytes = (bytes, decimals = 1) => {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        };

        const resizeImage = (file, targetWidth = 1400) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;

                    img.onload = () => {
                        // Calculate new dimensions
                        const scaleFactor = targetWidth / img.width;
                        const targetHeight = Math.round(img.height * scaleFactor);

                        // Create canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;

                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            reject(new Error('Failed to get canvas context'));
                            return;
                        }

                        // High quality scaling
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                        // Determine output type
                        const mimeType = file.type;
                        const quality = 0.92;

                        canvas.toBlob((blob) => {
                            if (!blob) {
                                reject(new Error('Canvas conversion failed'));
                                return;
                            }

                            // Generate new filename
                            const nameParts = file.name.split('.');
                            let ext = nameParts.pop();
                            const baseName = nameParts.join('.');
                            if (!ext) ext = 'jpg';
                            
                            const newName = `${baseName}14.${ext}`;
                            const url = URL.createObjectURL(blob);

                            resolve({
                                newName,
                                blob,
                                url,
                                status: 'completed',
                                newSize: blob.size,
                                width: targetWidth,
                                height: targetHeight,
                            });
                        }, mimeType, quality);
                    };

                    img.onerror = () => reject(new Error('Failed to load image'));
                };

                reader.onerror = () => reject(new Error('Failed to read file'));
            });
        };

        // --- Component: DropZone.tsx ---
        const DropZone = ({ onFilesDropped, isProcessing }) => {
            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                if (isProcessing) return;

                const files = Array.from(e.dataTransfer.files).filter((file) =>
                    file.type.startsWith('image/')
                );
                if (files.length > 0) {
                    onFilesDropped(files);
                }
            }, [onFilesDropped, isProcessing]);

            const handleFileInput = useCallback((e) => {
                if (e.target.files && !isProcessing) {
                    const files = Array.from(e.target.files).filter((file) =>
                        file.type.startsWith('image/')
                    );
                    onFilesDropped(files);
                }
                e.target.value = '';
            }, [onFilesDropped, isProcessing]);

            return (
                <div
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    className={`relative w-full border-2 border-dashed rounded-2xl transition-all duration-300 ease-in-out cursor-pointer group 
                        ${isProcessing
                            ? 'border-slate-700 bg-slate-800/50 cursor-not-allowed opacity-60'
                            : 'border-slate-600 bg-slate-800/30 hover:border-blue-500 hover:bg-slate-800/80'
                        }
                    `}
                >
                    <input
                        type="file"
                        multiple
                        accept="image/*"
                        onChange={handleFileInput}
                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed"
                        disabled={isProcessing}
                    />
                    <div className="flex flex-col items-center justify-center py-12 px-4 text-center">
                        <div className={`p-4 rounded-full mb-4 transition-colors ${isProcessing ? 'bg-slate-700 text-slate-500' : 'bg-blue-500/10 text-blue-400 group-hover:text-blue-300 group-hover:bg-blue-500/20'}`}>
                            {isProcessing ? <AlertCircle size={32} /> : <Upload size={32} />}
                        </div>
                        <h3 className="text-xl font-semibold text-slate-200 mb-2">
                            {isProcessing ? '正在处理中...' : '拖拽图片到这里'}
                        </h3>
                        <p className="text-slate-400 max-w-sm text-sm">
                            或点击选择文件。支持 PNG, JPG, WEBP。
                            <br />
                            <span className="text-slate-500 mt-1 block">单次最多处理 20 张图片。</span>
                        </p>
                    </div>
                </div>
            );
        };

        // --- Component: ProcessedList.tsx ---
        const ProcessedList = ({ images }) => {
            if (images.length === 0) return null;

            const handleDownloadSingle = (img) => {
                if (img.blob && img.status === 'completed') {
                    window.saveAs(img.blob, img.newName);
                }
            };

            return (
                <div className="w-full mt-8 space-y-3">
                    <div className="flex justify-between items-center mb-4 px-2">
                        <h3 className="text-lg font-medium text-slate-300">处理队列 ({images.length})</h3>
                    </div>
                    
                    <div className="grid grid-cols-1 gap-3">
                        {images.map((img) => (
                            <div
                                key={img.id}
                                className="flex items-center justify-between p-3 bg-slate-800 rounded-lg border border-slate-700/50 hover:border-slate-600 transition-colors shadow-sm"
                            >
                                <div className="flex items-center space-x-4 overflow-hidden">
                                    <div className="w-12 h-12 flex-shrink-0 bg-slate-900 rounded-md overflow-hidden flex items-center justify-center border border-slate-700">
                                        {img.url ? (
                                            <img src={img.url} alt="Thumbnail" className="w-full h-full object-cover" />
                                        ) : (
                                            <FileImage className="text-slate-600" size={24} />
                                        )}
                                    </div>

                                    <div className="flex flex-col min-w-0">
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm font-medium text-slate-200 truncate max-w-[150px] sm:max-w-xs" title={img.newName}>
                                                {img.status === 'completed' ? img.newName : img.originalName}
                                            </span>
                                        </div>
                                        <div className="flex items-center space-x-3 text-xs text-slate-500 mt-0.5">
                                            <span>{formatBytes(img.originalSize)}</span>
                                            {img.status === 'completed' && (
                                                <>
                                                    <span>→</span>
                                                    <span className="text-emerald-400 font-medium">{formatBytes(img.newSize)}</span>
                                                    <span className="text-slate-600">|</span>
                                                    <span>{img.width}px 宽</span>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center pl-2 sm:pl-4 space-x-2 sm:space-x-4">
                                    {img.status === 'processing' && (
                                        <div className="flex items-center text-blue-400 space-x-2">
                                            <Loader2 size={18} className="animate-spin" />
                                            <span className="text-xs hidden sm:inline">处理中</span>
                                        </div>
                                    )}
                                    {img.status === 'error' && (
                                        <div className="flex items-center text-red-400 space-x-2">
                                            <XCircle size={18} />
                                            <span className="text-xs hidden sm:inline">错误</span>
                                        </div>
                                    )}
                                    {img.status === 'completed' && (
                                        <>
                                            <div className="flex items-center text-emerald-500 space-x-2 mr-2">
                                                <CheckCircle2 size={18} />
                                                <span className="text-xs hidden sm:inline">完成</span>
                                            </div>
                                            <button
                                                onClick={() => handleDownloadSingle(img)}
                                                className="p-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                title="下载此图片"
                                            >
                                                <Download size={16} />
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App: App.tsx ---
        const MAX_BATCH_SIZE = 20;

        function App() {
            const [images, setImages] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                return () => {
                    images.forEach((img) => {
                        if (img.url) URL.revokeObjectURL(img.url);
                    });
                };
            }, [images]);

            const processBatch = async (newFiles) => {
                setError(null);
                setIsProcessing(true);

                const newImages = newFiles.map((file) => ({
                    id: Math.random().toString(36).substr(2, 9),
                    originalFile: file,
                    originalName: file.name,
                    newName: '',
                    status: 'pending',
                    blob: null,
                    url: null,
                    originalSize: file.size,
                    newSize: 0,
                    width: 0,
                    height: 0,
                }));

                setImages((prev) => [...prev, ...newImages]);

                for (const imgWrapper of newImages) {
                    setImages(current => current.map(item => item.id === imgWrapper.id ? {...item, status: 'processing'} : item));
                    
                    try {
                        const result = await resizeImage(imgWrapper.originalFile, 1400);
                        
                        setImages(current => current.map(item => 
                            item.id === imgWrapper.id 
                            ? { ...item, ...result }
                            : item
                        ));
                    } catch (err) {
                        console.error(err);
                        setImages(current => current.map(item => 
                            item.id === imgWrapper.id 
                            ? { ...item, status: 'error', errorMessage: '处理失败' }
                            : item
                        ));
                    }
                }

                setIsProcessing(false);
            };

            const handleFilesDropped = (files) => {
                if (images.length + files.length > MAX_BATCH_SIZE) {
                    setError(`单次批量处理限制为 ${MAX_BATCH_SIZE} 张图片。请清空列表后继续添加。`);
                    return;
                }
                processBatch(files);
            };

            const handleClearAll = () => {
                if (isProcessing) return;
                setImages([]);
                setError(null);
            };

            const handleDownloadAllZip = async () => {
                const zip = new JSZip();
                const completedImages = images.filter((img) => img.status === 'completed' && img.blob);
                
                if (completedImages.length === 0) return;

                completedImages.forEach((img) => {
                    if (img.blob) {
                        zip.file(img.newName, img.blob);
                    }
                });

                const content = await zip.generateAsync({ type: 'blob' });
                window.saveAs(content, 'resized_images_1400px.zip');
            };

            const handleDownloadAllIndividual = () => {
                const completedImages = images.filter((img) => img.status === 'completed' && img.blob);
                
                if (completedImages.length === 0) return;

                completedImages.forEach((img, index) => {
                    setTimeout(() => {
                        if (img.blob) {
                            window.saveAs(img.blob, img.newName);
                        }
                    }, index * 300);
                });
            };

            const completedCount = images.filter(i => i.status === 'completed').length;
            const isAllCompleted = completedCount > 0 && completedCount === images.length;

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-blue-500/30">
                    <div className="max-w-3xl mx-auto px-4 py-12 md:py-20">
                        
                        {/* Header */}
                        <div className="text-center mb-10 space-y-4">
                            <div className="inline-flex items-center justify-center p-3 bg-blue-500/10 rounded-2xl mb-2 ring-1 ring-blue-500/20 shadow-[0_0_30px_-10px_rgba(59,130,246,0.5)]">
                                <Zap className="text-blue-400" size={32} strokeWidth={2.5} />
                            </div>
                            <h1 className="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                                图片批量调宽<span className="text-blue-500">1400</span>
                            </h1>
                            <p className="text-slate-400 text-lg max-w-lg mx-auto leading-relaxed">
                                浏览器本地极速处理，自动调整图片宽度至 1400px 并保留原格式。
                                <br className="hidden sm:block"/>
                                安全、快速、无需上传服务器。
                            </p>
                            <div className="flex justify-center items-center gap-4 text-xs font-medium text-slate-500 uppercase tracking-wider pt-2">
                                <span className="flex items-center gap-1"><ShieldCheck size={14}/> 本地处理</span>
                                <span className="w-1 h-1 rounded-full bg-slate-700"></span>
                                <span>自动重命名</span>
                                <span className="w-1 h-1 rounded-full bg-slate-700"></span>
                                <span>ZIP 导出</span>
                            </div>
                        </div>

                        {/* Main Card */}
                        <div className="bg-slate-900/50 backdrop-blur-xl border border-slate-800 rounded-3xl p-6 shadow-2xl">
                            
                            <DropZone onFilesDropped={handleFilesDropped} isProcessing={isProcessing} />

                            {error && (
                                <div className="mt-4 p-4 bg-red-500/10 border border-red-500/20 text-red-200 rounded-xl text-sm text-center">
                                    {error}
                                </div>
                            )}

                            {/* Action Bar */}
                            {images.length > 0 && (
                                <div className="flex flex-col md:flex-row items-center justify-between gap-3 mt-8 pb-4 border-b border-slate-800">
                                    <div className="text-sm text-slate-400 font-medium">
                                        {completedCount} / {images.length} 已完成
                                    </div>
                                    
                                    <div className="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                                        <button
                                            onClick={handleClearAll}
                                            disabled={isProcessing}
                                            className="w-full sm:w-auto flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium text-slate-400 bg-slate-800 hover:bg-slate-700 hover:text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            <Trash2 size={16} />
                                            <span>清空列表</span>
                                        </button>

                                        <div className="flex w-full sm:w-auto gap-2">
                                            <button
                                                onClick={handleDownloadAllIndividual}
                                                disabled={!isAllCompleted}
                                                className="flex-1 sm:flex-none flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium text-blue-100 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                title="逐个下载所有文件"
                                            >
                                                <Download size={16} />
                                                <span>批量逐个下载</span>
                                            </button>

                                            <button
                                                onClick={handleDownloadAllZip}
                                                disabled={!isAllCompleted}
                                                className="flex-1 sm:flex-none flex items-center justify-center space-x-2 px-5 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded-lg shadow-lg shadow-blue-500/20 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                                            >
                                                <Archive size={16} />
                                                <span>打包下载 (ZIP)</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <ProcessedList images={images} />
                        </div>
                        
                        <div className="mt-8 text-center text-slate-600 text-xs">
                            单次最多处理 20 张图片。文件将自动添加后缀 "14"。
                        </div>

                    </div>
                </div>
            );
        }

        // --- Render ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
