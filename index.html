<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=yes" />
<title>æˆ¿å±‹å‡ºç§Ÿæ”¶è´¹å• â€” è·¨å¹³å°å¡«å†™ç³»ç»Ÿ</title>

<!-- ä¾èµ–åº“ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  /* è·¨å¹³å°ä¼˜åŒ– */
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft Yahei", "PingFang SC", sans-serif;
    margin: 0;
    padding: 12px;
    background: #f4f6f9;
    color: #111;
    line-height: 1.5;
  }
  
  h2 {
    margin: 0 0 8px 0;
    font-size: clamp(18px, 4vw, 24px);
    font-weight: 600;
  }
  
  .card {
    background: #fff;
    border-radius: 12px;
    padding: clamp(12px, 3vw, 16px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
    border: 1px solid #e1e5e9;
  }
  
  label {
    font-size: 14px;
    color: #333;
    font-weight: 500;
    display: block;
    margin-bottom: 6px;
  }
  
  input, select, button, textarea {
    font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #d6d9e0;
    background: #fff;
    width: 100%;
    margin-bottom: 8px;
    transition: all 0.2s ease;
  }
  
  input:focus, select:focus {
    border-color: #2563eb;
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .btn {
    background: #2563eb;
    color: #fff;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    text-align: center;
    transition: all 0.2s ease;
    flex: 1;
    min-width: 120px;
  }
  
  .btn:hover {
    background: #1d4ed8;
  }
  
  .btn:active {
    transform: scale(0.98);
  }
  
  .btn.secondary {
    background: #6b7280;
  }
  
  .btn.secondary:hover {
    background: #4b5563;
  }
  
  .btn.small {
    padding: 8px 12px;
    font-size: 13px;
    min-width: 80px;
  }
  
  .muted {
    color: #666;
    font-size: 13px;
    margin-bottom: 8px;
  }
  
  .flex {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .numeric {
    text-align: right;
  }
  
  /* è¡¨æ ¼å®¹å™¨ - å“åº”å¼è®¾è®¡ */
  .table-preview {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    background: #fff;
    max-width: 100%;
  }
  
  .table-preview table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px; /* ä¿è¯è¡¨æ ¼åœ¨ç§»åŠ¨ç«¯å¯ä»¥æ¨ªå‘æ»šåŠ¨ */
  }
  
  .table-preview th, .table-preview td {
    border: 1px solid #e1e5e9;
    padding: 10px 8px;
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
  }
  
  .table-preview th {
    background: #f8fafc;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .table-preview input {
    margin: 0;
    padding: 6px 8px;
    font-size: 14px;
    border: 1px solid #e1e5e9;
    border-radius: 4px;
    width: 100%;
    min-width: 60px;
  }
  
  /* å¯¼å‡ºæ¨¡æ¿æ ·å¼ */
  .export-template { 
    font-family: "Arial", "Microsoft Yahei", sans-serif; 
    background: #fff; 
    padding: 20px; 
  }
  
  .export-template .tg {
    border-collapse: collapse;
    border-spacing: 0; 
    width: 100%;
  }
  
  .export-template td, .export-template th {
    border-color: black;
    border-style: solid;
    border-width: 1px;
    font-size: 24px;
    padding: 15px 8px;
    word-break: normal;
  }
  
  .export-template .tg-rzxb {
    font-size: 32px;
    font-weight: bold;
    text-align: center;
    vertical-align: middle;
  }
  
  .export-template .tg-gqad {
    font-size: 26px;
    text-align: center;
    vertical-align: middle;
  }
  
  .export-template .tg-nrix {
    text-align: center;
    vertical-align: middle;
  }
  
  /* éšè— printAreaï¼ˆå¯¼å‡ºæ—¶ä¸´æ—¶æ˜¾ç¤ºï¼‰ */
  #printArea {
    display: none;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    body {
      padding: 8px;
    }
    
    .card {
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .controls {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      min-width: auto;
    }
    
    .flex {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    
    /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
    .table-preview {
      font-size: 13px;
    }
    
    .table-preview th, .table-preview td {
      padding: 8px 4px;
    }
    
    .table-preview input {
      padding: 4px 6px;
      font-size: 13px;
    }
    
    /* ç§»åŠ¨ç«¯æŒ‰é’®ç»„ä¼˜åŒ– */
    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .button-group .btn {
      margin: 0;
    }
  }
  
  @media (min-width: 769px) {
    .table-container {
      max-height: 60vh;
      overflow: auto;
    }
    
    /* æ¡Œé¢ç«¯å¸ƒå±€ä¼˜åŒ– */
    .header-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
  }
  
  /* åŠ è½½æŒ‡ç¤ºå™¨ */
  .loader {
    display: none;
    text-align: center;
    padding: 20px;
  }
  
  .loader .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2563eb;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* çŠ¶æ€æç¤º */
  .status {
    padding: 8px 12px;
    border-radius: 6px;
    margin: 8px 0;
    font-size: 14px;
  }
  
  .status.success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }
  
  .status.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
</style>
</head>
<body>
  <h2>æˆ¿å±‹å‡ºç§Ÿæ”¶è´¹å• â€” è·¨å¹³å°å¡«å†™ç³»ç»Ÿ</h2>
  <div class="muted">æ”¯æŒç”µè„‘å’Œæ‰‹æœºè®¿é—® / æœ¬åœ°ä¿å­˜ / GitHub åŒæ­¥ / å¯¼å‡º Excel & JPG</div>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div>å¤„ç†ä¸­...</div>
  </div>

  <div class="card">
    <div class="header-controls">
      <div>
        <div class="flex">
          <div style="flex: 1;">
            <label>å®¢æˆ·</label>
            <select id="customerSelect"></select>
          </div>
          <div style="flex: 1;">
            <label>å¹´-æœˆ</label>
            <input id="yearmonth" type="month" min="2023-01" max="2026-12" />
          </div>
        </div>

      <!-- æœˆä»½å¿«é€Ÿå¯¼èˆª -->
      <div style="display: flex; gap: 8px; align-items: center; margin-top: 12px;">
        <button class="btn small" id="btnPrevMonth">â† ä¸Šæœˆ</button>
        <span style="font-weight: 500; flex: 1; text-align: center;" id="currentMonthDisplay"></span>
        <button class="btn small" id="btnNextMonth">ä¸‹æœˆ â†’</button>
        <span style="color: #666; font-size: 13px; min-width: 80px; text-align: right;" id="monthStatus"></span>
      </div>
        
        <div style="margin-top: 12px;">
          <label>æ“ä½œ</label>
          <div class="controls">
            <button class="btn" id="btnNewMonth">æ–°å»º/åˆ‡æ¢æœˆä»½</button>
            <button class="btn secondary" id="btnSave">ä¿å­˜æœ¬æœˆ</button>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px;">
        <div class="muted">åˆè®¡äººæ°‘å¸</div>
        <div id="totalRmb" style="font-size: 24px; font-weight: 600; color: #2563eb;">0å…ƒ</div>
      </div>
    </div>
    
    <div style="margin-top: 12px;" class="button-group">
      <button class="btn" id="btnExportXlsx">å¯¼å‡º Excel</button>
      <button class="btn" id="btnExportJpg">å¯¼å‡º JPG</button>
    </div>
  </div>

  <div class="card">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
      <strong>é¡¹ç›®å¡«å†™åŒº</strong>
      <div class="muted" style="flex: 1;">è¾“å…¥æœ¬æœˆè¡¨æ•° / ä¸Šæœˆè¡¨æ•°æˆ–ç›´æ¥ç¼–è¾‘é‡‘é¢</div>
      <div>
        <button class="btn small" id="btnAddRow">æ–°å¢è¡Œ</button>
        <button class="btn small secondary" id="btnResetTemplate">é‡ç½®æ¨¡æ¿</button>
      </div>
    </div>
    <div class="table-container">
      <div id="tableContainer" class="table-preview"></div>
    </div>
  </div>

  <div class="card">
    <div class="flex">
      <div style="flex: 1;">
        <strong>å®¢æˆ·ç®¡ç†</strong>
        <div style="margin-top: 8px;">
          <input id="newCustomerName" placeholder="è¾“å…¥æ–°å®¢æˆ·åç§°" />
          <div class="controls">
            <button class="btn small" id="btnAddCustomer">æ–°å¢å®¢æˆ·</button>
            <button class="btn small secondary" id="btnRemoveCustomer">åˆ é™¤å®¢æˆ·</button>
          </div>
        </div>
      </div>
      
      <div style="flex: 2;">
        <strong>GitHub åŒæ­¥</strong>
        <div style="margin-top: 8px;">
          <input id="ghToken" placeholder="GitHub Personal Access Token" type="password" />
          <div class="flex">
            <input id="ghOwner" placeholder="Owner" value="kwnewguy" />
            <input id="ghRepo" placeholder="Repo" value="rent-management-data" />
          </div>
          <input id="ghPath" placeholder="æ–‡ä»¶è·¯å¾„" value="rent-data.json" />
          
          <div class="controls">
            <button class="btn small" id="btnGhUpload">ä¸Šä¼ åˆ° GitHub</button>
            <button class="btn small" id="btnGhDownload">ä» GitHub åŠ è½½</button>
            <button class="btn small secondary" id="btnExportJson">å¯¼å‡º JSON</button>
            <button class="btn small" id="btnImportJson">å¯¼å…¥ JSON</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼å‡ºæ—¶æ„é€ æ­¤åŒºåŸŸï¼ˆä¸´æ—¶æ˜¾ç¤ºï¼‰ï¼Œç”¨äºç”Ÿæˆå›¾ç‰‡ -->
  <div id="printArea" style="display:none; width:1920px; height:1440px; background:#ffffff; box-sizing:border-box; padding:40px;"></div>

<script>
// ================== å¸¸ç”¨å·¥å…·ä¸è§„åˆ™ ==================
const DB_KEY = 'rent_charges_db_responsive_v1'
const GH_TOKEN_KEY = 'rent_charges_gh_token'

// æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
function showLoader() {
    document.getElementById('loader').style.display = 'block';
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
}

function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) || {customers:{}, records:{}} }catch(e){ return {customers:{}, records:{}} } }
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)) }
function saveGhToken(t){ if(t) localStorage.setItem(GH_TOKEN_KEY, t); else localStorage.removeItem(GH_TOKEN_KEY) }
function loadGhToken(){ return localStorage.getItem(GH_TOKEN_KEY) || '' }
function toNumberOrNaN(v){ if(v==null||v==='') return NaN; const n = Number(String(v).replace(/[^\d.-]/g,'')); return isFinite(n)?n:NaN }
function integerPart(v){ 
    if(isNaN(Number(v))) return 0
    return v>=0? Math.trunc(v) : Math.trunc(v)
}
function moneyIntStr(v){ return String(integerPart(Math.floor(Number(v)||0))) }
function formatYMD(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}å¹´${m}æœˆ${d}æ—¥` }
function prevMonth(ym){ const [y,m] = ym.split('-').map(Number); let y2=y, m2=m-1; if(m2<1){ y2=y-1; m2=12 } return `${String(y2).padStart(4,'0')}-${String(m2).padStart(2,'0')}` }
function monthKey(customer, ym){ return customer + '::' + ym }

/* å°†é‡‘é¢æ‹†ä½ï¼ˆç”¨äºæ˜¾ç¤ºå„ä½ï¼‰ */
function splitIntegerToCols(amount){
    const n = Math.abs(Math.trunc(Number(amount)||0))
    let s = String(n)
    if(s.length>6) s = s.slice(-6)
    s = s.padStart(6,'0')
    return [s[0], s[1], s[2], s[3], s[4], s[5]]
}

// ================== æ™ºèƒ½æ•°æ®ç»§æ‰¿ç›¸å…³å‡½æ•° ==================
function nextMonth(ym) {
  const [y, m] = ym.split('-').map(Number);
  let y2 = y, m2 = m + 1;
  if (m2 > 12) { y2 = y + 1; m2 = 1 }
  return `${String(y2).padStart(4, '0')}-${String(m2).padStart(2, '0')}`;
}

/* ä¿®å¤æ™ºèƒ½æ•°æ®ç»§æ‰¿ */
function inheritDataIntelligently(template, lastMonthItems, currentMonth, lastMonth) {
  console.log(`ğŸ”„ æ‰§è¡Œæ™ºèƒ½ç»§æ‰¿: ä» ${lastMonth} åˆ° ${currentMonth}`);
  console.log('ğŸ“‹ ä¸Šæœˆæ•°æ®:', lastMonthItems);
  console.log('ğŸ“‹ æ¨¡æ¿æ•°æ®:', template);
  
  return template.map(templateItem => {
    // æ”¹è¿›åŒ¹é…é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨idåŒ¹é…ï¼Œç„¶åä½¿ç”¨nameåŒ¹é…
    let lastItem = lastMonthItems.find(item => item.id === templateItem.id);
    if (!lastItem) {
      lastItem = lastMonthItems.find(item => item.name === templateItem.name);
    }

    if (!lastItem) {
      console.log(`âŒ é¡¹ç›® ${templateItem.name} åœ¨ä¸Šæœˆæ•°æ®ä¸­æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ¨¡æ¿`);
      return templateItem;
    }

    // æ·±æ‹·è´æ¨¡æ¿é¡¹ç›®
    const newItem = JSON.parse(JSON.stringify(templateItem));
    
    if (templateItem.type === 'usage') {
      // ç”¨é‡é¡¹ç›®ï¼šç»§æ‰¿ä¸Šæœˆ"æœ¬æœˆè¡¨æ•°"ä½œä¸ºæœ¬æœˆ"ä¸Šæœˆè¡¨æ•°"
      newItem.prev = lastItem.cur || lastItem.prev || '';
      newItem.cur = ''; // æœ¬æœˆè¡¨æ•°æ¸…ç©º
      newItem.unitPrice = lastItem.unitPrice || templateItem.unitPrice;
      
      console.log(`âœ… ç”¨é‡é¡¹ç›® ${templateItem.name}: ä¸Šæœˆè¡¨æ•°=${lastItem.cur} â†’ æœ¬æœˆä¸Šæœˆè¡¨æ•°=${newItem.prev}`);
    } else {
      // å›ºå®šé¡¹ç›®ï¼šç›´æ¥ç»§æ‰¿é‡‘é¢ä¸å•ä»·
      newItem.fixedAmount = lastItem.fixedAmount || templateItem.fixedAmount;
      newItem.unitPrice = lastItem.unitPrice || templateItem.unitPrice;
      console.log(`âœ… å›ºå®šé¡¹ç›® ${templateItem.name}: ç»§æ‰¿é‡‘é¢=${newItem.fixedAmount}`);
    }
    
    return newItem;
  });
}

/* ä¿®å¤æ™ºèƒ½åŠ è½½æœˆä»½æ•°æ® */
function loadMonthData(customer, ym) {
  const key = monthKey(customer, ym);
  
  console.log(`ğŸ” åŠ è½½æœˆä»½æ•°æ®: ${key}`);
  
  // 1. å¦‚æœè¯¥æœˆä»½å·²æœ‰ä¿å­˜æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰æœ‰æ•ˆæ•°æ®
  if (db.records[key]) {
    const existingItems = db.records[key].items || [];
    
    // æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼šæ˜¯å¦æœ‰ä»»ä½•é¡¹ç›®åŒ…å«çœŸå®æ•°æ®
    const hasRealData = existingItems.some(item => {
      if (item.type === 'usage') {
        return item.cur !== '' || item.prev !== '';
      } else {
        return item.fixedAmount > 0;
      }
    });
    
    if (hasRealData) {
      console.log(`âœ… åŠ è½½ ${ym} æœˆå·²ä¿å­˜æ•°æ®ï¼ˆæœ‰çœŸå®æ•°æ®ï¼‰`);
      return existingItems;
    } else {
      console.log(`ğŸ”„ æ£€æµ‹åˆ° ${ym} æœˆæ•°æ®ä¸ºç©ºï¼Œå°†å°è¯•ä»ä¸Šæœˆç»§æ‰¿`);
      // åˆ é™¤è¿™ä¸ªç©ºè®°å½•ï¼Œè®©æ™ºèƒ½ç»§æ‰¿é€»è¾‘å¯ä»¥æ‰§è¡Œ
      delete db.records[key];
      saveDB(db);
    }
  }

  // 2. æ–°æœˆä»½æˆ–ç©ºæ•°æ®æœˆä»½ï¼šæ™ºèƒ½ç»§æ‰¿
  const template = JSON.parse(JSON.stringify(db.customers[customer]?.template || []));
  const lastMonth = prevMonth(ym);
  const lastMonthKey = monthKey(customer, lastMonth);
  const lastMonthData = db.records[lastMonthKey];
  
  if (lastMonthData && lastMonthData.items && lastMonthData.items.length > 0) {
    console.log(`ğŸ”„ ä» ${lastMonth} æœˆæ™ºèƒ½ç»§æ‰¿æ•°æ®åˆ° ${ym} æœˆ`);
    const inheritedData = inheritDataIntelligently(template, lastMonthData.items, ym, lastMonth);
    console.log('ğŸ“Š ç»§æ‰¿åçš„æ•°æ®:', inheritedData);
    return inheritedData;
  }

  // 3. å…¨æ–°æœˆä»½ï¼Œä½¿ç”¨æ¨¡æ¿
  console.log(`ğŸ†• å…¨æ–°æœˆä»½ ${ym}ï¼Œä½¿ç”¨æ¨¡æ¿`);
  return template;
}

/* ä¿®å¤æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å®é™…ä¿®æ”¹ */
function hasDataChanges(items) {
  return items.some(item => {
    if (item.type === 'usage') {
      // ç”¨é‡é¡¹ç›®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¡¨æ•°æ•°æ®
      return item.cur !== '' || item.prev !== '';
    } else {
      // å›ºå®šé¡¹ç›®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é‡‘é¢
      return item.fixedAmount > 0;
    }
  });
}

/* æ•°æ®éªŒè¯ */
function validateMonthData(items, month) {
  const errors = [];
  
  items.forEach((item, index) => {
    if (item.type === 'usage') {
      if (!item.cur && !item.prev) {
        // å…¨æ–°æœˆä»½ï¼Œä¸¤ä¸ªéƒ½ä¸ºç©ºæ˜¯æ­£å¸¸çš„
        return;
      }
      
      if (!item.cur && item.prev) {
        errors.push(`â€¢ ${item.name}: è¯·å¡«å†™"æœ¬æœˆè¡¨æ•°"`);
      }
      
      if (item.cur && !item.prev) {
        errors.push(`â€¢ ${item.name}: è¯·å¡«å†™"ä¸Šæœˆè¡¨æ•°"`);
      }
      
      if (item.cur && item.prev) {
        const curNum = toNumberOrNaN(item.cur);
        const prevNum = toNumberOrNaN(item.prev);
        
        if (curNum < prevNum) {
          errors.push(`â€¢ ${item.name}: æœ¬æœˆè¡¨æ•°ä¸èƒ½å°äºä¸Šæœˆè¡¨æ•°`);
        }
      }
    }
  });
  
  return {
    isValid: errors.length === 0,
    errors: errors
  };
}

/* æ˜¾ç¤ºToastæç¤º */
function showToast(message, type = 'info', duration = 3000) {
  // ç§»é™¤ç°æœ‰çš„toast
  const existingToast = document.getElementById('globalToast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.id = 'globalToast';
  toast.innerHTML = `
    <div style="
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      color: white; padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000;
      max-width: 400px; text-align: center; font-size: 14px;
    ">
      ${message}
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, duration);
}

/* ================== é»˜è®¤æ¨¡æ¿ä¸åˆå§‹åŒ– ================== */
const defaultTemplates = {
    "è”¡å…ˆç”Ÿ(1æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:4500, unitPrice:0 },
        { id:'elec_1f', name:'1æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 }
    ],
    "æ¢å…ˆç”Ÿ(1æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:1800, unitPrice:0 },
        { id:'elec_1f', name:'1æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 }
    ],
    "èŠŠæˆå…¬å¸(2/3/5æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:11000, unitPrice:0 },
        { id:'elevator', name:'ç”µæ¢¯å…¬æ‘Š', type:'fixed', fixedAmount:540, unitPrice:0 },
        { id:'2F_elec', name:'äºŒæ¥¼å®¿èˆç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 },
        { id:'3F_elec', name:'ä¸‰æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 },
        { id:'5F_elec', name:'äº”æ¥¼å®¿èˆç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 },
        { id:'2F_water', name:'äºŒæ¥¼è½¦é—´æ°´è´¹', type:'usage', cur:'', prev:'', unitPrice:6 },
        { id:'3F_water', name:'ä¸‰æ¥¼è½¦é—´æ°´è´¹', type:'usage', cur:'', prev:'', unitPrice:6 },
        { id:'5F_office_water', name:'äº”æ¥¼åŠå…¬æ°´è´¹', type:'usage', cur:'', prev:'', unitPrice:6 }
    ],
    "è”¡å‡¯å…ˆç”Ÿ(4æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:3600, unitPrice:0 },
        { id:'elevator', name:'ç”µæ¢¯å…¬æ‘Š', type:'fixed', fixedAmount:180, unitPrice:0 },
        { id:'4F_elec', name:'4æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 }
    ],
    "å¾å…ˆç”Ÿ(5æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:5300, unitPrice:0 },
        { id:'elevator', name:'ç”µæ¢¯å…¬æ‘Š', type:'fixed', fixedAmount:270, unitPrice:0 },
        { id:'5F_elec', name:'äº”æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 },
        { id:'5F_water', name:'äº”æ¥¼æ°´è´¹', type:'usage', cur:'', prev:'', unitPrice:6 }
    ],
    "æç”Ÿ(6æ¥¼)": [
        { id:'rent', name:'æˆ¿ç§Ÿ', type:'fixed', fixedAmount:4300, unitPrice:0 },
        { id:'elevator', name:'ç”µæ¢¯å…¬æ‘Š', type:'fixed', fixedAmount:270, unitPrice:0 },
        { id:'office_elec', name:'åŠå…¬æ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 },
        { id:'dorm_elec', name:'å®¿èˆæ¥¼ç”µè´¹', type:'usage', cur:'', prev:'', unitPrice:0.9 }
    ]
}

let db = loadDB()
if(!db.customers || Object.keys(db.customers).length===0){
    db = { customers:{}, records:{} }
    for(const k of Object.keys(defaultTemplates)) db.customers[k] = { template: JSON.parse(JSON.stringify(defaultTemplates[k])) }
    saveDB(db)
}

/* ================== UI å…ƒç´  ================== */
const customerSelect = document.getElementById('customerSelect')
const yearmonthInput = document.getElementById('yearmonth')
const tableContainer = document.getElementById('tableContainer')
const totalRmb = document.getElementById('totalRmb')
const btnAddRow = document.getElementById('btnAddRow')
const btnSave = document.getElementById('btnSave')
const btnNewMonth = document.getElementById('btnNewMonth')
const btnExportXlsx = document.getElementById('btnExportXlsx')
const btnExportJpg = document.getElementById('btnExportJpg')
const btnAddCustomer = document.getElementById('btnAddCustomer')
const btnRemoveCustomer = document.getElementById('btnRemoveCustomer')
const newCustomerName = document.getElementById('newCustomerName')
const btnResetTemplate = document.getElementById('btnResetTemplate')
const ghTokenInput = document.getElementById('ghToken')
const ghOwnerInput = document.getElementById('ghOwner')
const ghRepoInput = document.getElementById('ghRepo')
const ghPathInput = document.getElementById('ghPath')
const btnGhUpload = document.getElementById('btnGhUpload')
const btnGhDownload = document.getElementById('btnGhDownload')
const btnExportJson = document.getElementById('btnExportJson')
const btnImportJson = document.getElementById('btnImportJson')
const fileInput = document.getElementById('fileInput')
const printArea = document.getElementById('printArea')

/* å¡«é»˜è®¤ GitHub é…ç½® */
ghOwnerInput.value = 'kwnewguy'
ghRepoInput.value = 'rent-management-data'
ghPathInput.value = 'rent-data.json'
ghTokenInput.value = loadGhToken()

/* åˆ·æ–°å®¢æˆ·åˆ—è¡¨ */
function refreshCustomerList(){
    customerSelect.innerHTML = ''
    Object.keys(db.customers).forEach(k=>{
        const opt = document.createElement('option'); opt.value=k; opt.textContent=k; customerSelect.appendChild(opt)
    })
}
refreshCustomerList()

/* é»˜è®¤æœˆä»½ï¼šè‡ªåŠ¨è·³è½¬åˆ°å½“å‰æœˆè¡¨å• */
const now = new Date()
yearmonthInput.value = now.toISOString().slice(0,7)

/* æ„å»ºè¡¨æ ¼ - ä½¿ç”¨æ™ºèƒ½æ•°æ®åŠ è½½ */
function buildTable() {
  const customer = customerSelect.value;
  const ym = yearmonthInput.value;
  
  if (!customer || !ym) {
    tableContainer.innerHTML = '<div class="muted">è¯·é€‰æ‹©å®¢æˆ·ä¸æœˆä»½</div>';
    return;
  }
  
  // ä½¿ç”¨æ–°çš„æ™ºèƒ½æ•°æ®åŠ è½½
  const tableData = loadMonthData(customer, ym);
  renderTable(tableData);
  
  // æ›´æ–°æœˆä»½çŠ¶æ€æ˜¾ç¤º
  updateMonthStatus(customer, ym);
}

/* æ›´æ–°æœˆä»½çŠ¶æ€æ˜¾ç¤º */
function updateMonthStatus(customer, ym) {
  const statusEl = document.getElementById('monthStatus');
  if (!statusEl) return;
  
  const key = monthKey(customer, ym);
  const hasData = db.records[key];
  const lastMonth = prevMonth(ym);
  const hasLastMonth = db.records[monthKey(customer, lastMonth)];
  
  let status = '';
  if (hasData) {
    status = 'ğŸ“ å·²ä¿å­˜';
  } else if (hasLastMonth) {
    status = 'ğŸ”„ ä»ä¸Šæœˆç»§æ‰¿';
  } else {
    status = 'ğŸ†• æ–°æœˆä»½';
  }
  
  statusEl.textContent = status;
}

/* ä¿®å¤æ¸²æŸ“ç¼–è¾‘è¡¨æ ¼ */
function renderTable(template){
    console.log('ğŸ¨ æ¸²æŸ“è¡¨æ ¼ï¼Œæ•°æ®:', template);
    
    const wrap = document.createElement('div')
    let html = `
    <table style="width:100%;border-collapse:collapse; font-size:14px;">
        <thead>
            <tr style="background:#f8fafc">
                <th style="padding:10px 6px; min-width:50px;">åºå·</th>
                <th style="padding:10px 6px; min-width:120px;">é¡¹ç›®</th>
                <th style="padding:10px 6px; min-width:100px;">æœ¬æœˆè¡¨æ•°</th>
                <th style="padding:10px 6px; min-width:100px;">ä¸Šæœˆè¡¨æ•°</th>
                <th style="padding:10px 6px; min-width:80px;">å®ç”¨</th>
                <th style="padding:10px 6px; min-width:90px;">å•ä»·(å…ƒ)</th>
                <th style="padding:10px 6px; min-width:100px;">é‡‘é¢(å…ƒ)</th>
                <th style="padding:10px 6px; min-width:140px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tblBody">`
    
    template.forEach((row, i) => {
        const cur = row.cur ?? '';
        const prev = row.prev ?? '';
        const up = row.unitPrice ?? '';
        const fa = row.fixedAmount ?? '';

        html += `<tr data-i="${i}" data-id="${row.id || 'r'+i}">
            <td style="padding:8px 6px">${i + 1}</td>
            <td style="padding:8px 6px"><input data-field="name" value="${escapeHtml(row.name || '')}" style="width:100%; min-width:100px;" placeholder="é¡¹ç›®åç§°"/></td>
            <td style="padding:8px 6px"><input data-field="cur" value="${cur}" class="numeric" placeholder="0" /></td>
            <td style="padding:8px 6px"><input data-field="prev" value="${prev}" class="numeric" placeholder="0" /></td>
            <td style="padding:8px 6px"><input data-field="usage" readonly class="numeric" /></td>
            <td style="padding:8px 6px"><input data-field="unitPrice" value="${up}" class="numeric" placeholder="0.00" /></td>
            <td style="padding:8px 6px"><input data-field="amount" readonly class="numeric" value="${row.type === 'fixed' ? integerPart(row.fixedAmount || 0) : ''}" /></td>
            <td style="padding:8px 6px">
                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <button class="btn small removeRow" style="padding: 6px 8px; font-size: 12px;">åˆ é™¤</button>
                    <button class="btn small secondary toggleType" style="padding: 6px 8px; font-size: 12px;">${row.type === 'fixed' ? 'å›ºå®š' : 'è®¡ç”¨é‡'}</button>
                </div>
            </td>
        </tr>`;
    });

    html += '</tbody></table>'
    wrap.innerHTML = html
    tableContainer.innerHTML = ''; 
    tableContainer.appendChild(wrap)

    // å…¶ä½™çš„äº‹ä»¶ç›‘å¬é€»è¾‘ä¿æŒä¸å˜...
    const tbody = tableContainer.querySelector('#tblBody')
    function updateRow(tr){
        const i = parseInt(tr.getAttribute('data-i'))
        const curVal = tr.querySelector('[data-field=cur]').value
        const prevVal = tr.querySelector('[data-field=prev]').value
        const upVal = tr.querySelector('[data-field=unitPrice]').value
        const cur = toNumberOrNaN(curVal), prev = toNumberOrNaN(prevVal), up = toNumberOrNaN(upVal)
        const tplRow = db.customers[customerSelect.value].template[i]
        const usageField = tr.querySelector('[data-field=usage]')
        const amountField = tr.querySelector('[data-field=amount]')
        
        if(tplRow && tplRow.type === 'fixed'){
            const fixedVal = toNumberOrNaN(amountField.value)
            if(!isNaN(fixedVal)) amountField.value = integerPart(fixedVal)
            usageField.value = ''
        } else {
            if(!isNaN(cur) && !isNaN(prev)){ 
                const usage = cur - prev; 
                usageField.value = integerPart(usage) 
            } else {
                usageField.value = ''
            }
            const usageNum = toNumberOrNaN(usageField.value)
            if(!isNaN(usageNum) && !isNaN(up)){ 
                const amt = usageNum * up; 
                amountField.value = integerPart(Math.floor(amt)) 
            } else {
                amountField.value = ''
            }
        }
        calcTotal()
    }
    
    // initial update
    tbody.querySelectorAll('tr').forEach(tr => updateRow(tr));
    tbody.addEventListener('input', (e)=>{
        const tr = e.target.closest('tr'); if(!tr) return; updateRow(tr)
    })
    tbody.addEventListener('click', (e)=>{
        if(e.target.classList.contains('removeRow')){
            const tr = e.target.closest('tr'); 
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) {
                tr.remove(); 
                tbody.querySelectorAll('tr').forEach((r,idx)=> {
                    r.setAttribute('data-i', idx);
                    r.cells[0].textContent = idx+1
                }); 
                calcTotal()
            }
        }
        if(e.target.classList.contains('toggleType')){
            const tr = e.target.closest('tr'); const idx = parseInt(tr.getAttribute('data-i'))
            const customer = customerSelect.value
            if(!db.customers[customer] || !db.customers[customer].template) return
            const t = db.customers[customer].template[idx]
            if(!t) return
            if(t.type === 'fixed'){ 
                t.type='usage'; 
                delete t.fixedAmount; 
                t.cur=''; 
                t.prev=''; 
                t.unitPrice = t.unitPrice || 0.9 
            } else { 
                t.type='fixed'; 
                t.fixedAmount = t.fixedAmount || 0; 
                delete t.cur; 
                delete t.prev; 
                t.unitPrice = t.unitPrice || 0 
            }
            saveDB(db); buildTable()
        }
    })
}

/* è®¡ç®—åˆè®¡ï¼ˆå³æ—¶æ˜¾ç¤ºï¼‰ */
function calcTotal(){
    const trs = tableContainer.querySelectorAll('tbody tr')
    let total = 0
    trs.forEach(tr=>{
        const amt = toNumberOrNaN(tr.querySelector('[data-field=amount]').value)
        if(!isNaN(amt) && amt>0) total += integerPart(amt)
    })
    totalRmb.textContent = `${total}å…ƒ`
    return total
}

/* è¯»å– UI ä¸º itemsï¼ˆä¿å­˜ç”¨ï¼‰ */
function readItemsFromUI(){
    const rows = tableContainer.querySelectorAll('tbody tr')
    const items = []
    rows.forEach((tr,idx)=>{
        const name = tr.querySelector('[data-field=name]').value
        const cur = tr.querySelector('[data-field=cur]').value
        const prev = tr.querySelector('[data-field=prev]').value
        const unitPrice = toNumberOrNaN(tr.querySelector('[data-field=unitPrice]').value)
        const amount = toNumberOrNaN(tr.querySelector('[data-field=amount]').value)
        // determine type by template if exists
        const customer = customerSelect.value
        const tpl = db.customers[customer] && db.customers[customer].template[idx]
        if(tpl && tpl.type === 'fixed'){
            items.push({ id: tpl.id||('r'+idx), name, type:'fixed', fixedAmount: integerPart(amount || tpl.fixedAmount || 0), unitPrice: isNaN(unitPrice)?0:unitPrice })
        } else {
            items.push({ id: tpl?tpl.id:('r'+idx), name, type:'usage', cur: cur||'', prev: prev||'', unitPrice: isNaN(unitPrice)?0:unitPrice, amount: isNaN(amount)?null:integerPart(amount) })
        }
    })
    return items
}

/* ä¿å­˜å½“å‰æœˆæ•°æ® - ç»‘å®šåˆ°æ–°çš„ä¿å­˜é€»è¾‘ */
btnSave.addEventListener('click', saveCurrentMonth);

/* get template skeleton from current UI (for persisting template) */
/* ä¿®å¤è·å–æ¨¡æ¿å‡½æ•° */
function getTemplateFromUI(){
    const rows = tableContainer.querySelectorAll('tbody tr')
    const tpl = []
    rows.forEach((tr,idx)=>{
        const name = tr.querySelector('[data-field=name]').value
        const cur = tr.querySelector('[data-field=cur]').value
        const prev = tr.querySelector('[data-field=prev]').value
        const unitPrice = toNumberOrNaN(tr.querySelector('[data-field=unitPrice]').value)
        const amount = toNumberOrNaN(tr.querySelector('[data-field=amount]').value)

        // âœ… ä¿®å¤ï¼šä»DOMå±æ€§è·å–IDï¼Œç¡®ä¿ä¸€è‡´æ€§
        const existingId = tr.getAttribute('data-id') || `r${idx}`
        
        if((cur==='' && prev==='') && !isNaN(amount)){
            tpl.push({ 
                id: existingId, 
                name, 
                type:'fixed', 
                fixedAmount: integerPart(amount), 
                unitPrice: isNaN(unitPrice)?0:unitPrice 
            })
        } else {
            tpl.push({ 
                id: existingId, 
                name, 
                type:'usage', 
                cur: cur||'', 
                prev: prev||'', 
                unitPrice: isNaN(unitPrice)?0:unitPrice 
            })
        }
    })
    return tpl
}

/* æ–°å¢ / é‡ç½® / å®¢æˆ·ç®¡ç† */
btnAddRow.addEventListener('click', ()=>{
    const c = customerSelect.value; if(!c) return alert('è¯·é€‰æ‹©å®¢æˆ·')
    const tpl = db.customers[c].template || []
    tpl.push({ id:'r'+tpl.length, name:'æ–°é¡¹ç›®', type:'usage', cur:'', prev:'', unitPrice:0.9 })
    db.customers[c].template = tpl; saveDB(db); buildTable()
})
btnResetTemplate.addEventListener('click', ()=>{
    const c = customerSelect.value; if(!c) return alert('è¯·é€‰æ‹©å®¢æˆ·')
    if(!confirm('ç¡®è®¤é‡ç½®æ¨¡æ¿ä¸ºé»˜è®¤ï¼Ÿå°†è¦†ç›–å½“å‰å®¢æˆ·æ¨¡æ¿')) return
    if(defaultTemplates[c]) db.customers[c].template = JSON.parse(JSON.stringify(defaultTemplates[c]))
    else db.customers[c].template = []
    saveDB(db); buildTable()
})
document.getElementById('btnAddCustomer').addEventListener('click', ()=>{
    const name = newCustomerName.value.trim(); if(!name) return alert('è¯·è¾“å…¥å®¢æˆ·å'); if(db.customers[name]) return alert('å®¢æˆ·å·²å­˜åœ¨')
    db.customers[name] = { template: [] }; saveDB(db); refreshCustomerList(); customerSelect.value = name; buildTable()
    newCustomerName.value = '';
})
document.getElementById('btnRemoveCustomer').addEventListener('click', ()=>{
    const c = customerSelect.value; if(!c) return alert('è¯·é€‰æ‹©å®¢æˆ·'); if(!confirm('ç¡®è®¤åˆ é™¤å®¢æˆ·åŠå…¶æ‰€æœ‰æœ¬åœ°è®°å½•ï¼Ÿ')) return
    delete db.customers[c]; Object.keys(db.records).forEach(k=>{ if(k.startsWith(c+'::')) delete db.records[k] })
    saveDB(db); refreshCustomerList(); buildTable()
})

/* GitHub helpers (client-side) â€” token stored in localStorage when user clicks Save Token */
async function ghGetFileSha(owner, repo, path, token){
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`
    const resp = await fetch(url, { headers:{ Authorization: 'token '+token, Accept:'application/vnd.github.v3+json' }})
    if(resp.status===200){ const j = await resp.json(); return j.sha }
    if(resp.status===404) return null
    throw new Error('GitHub API é”™è¯¯: ' + resp.status)
}
async function ghUpload(owner, repo, path, token, contentStr, message='sync rent data'){
    const sha = await ghGetFileSha(owner, repo, path, token)
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`
    const body = { message, content: btoa(unescape(encodeURIComponent(contentStr))) }
    if(sha) body.sha = sha
    const resp = await fetch(url, { method:'PUT', headers:{ Authorization: 'token '+token, Accept:'application/vnd.github.v3+json' }, body: JSON.stringify(body) })
    if(!resp.ok) throw new Error('ä¸Šä¼ å¤±è´¥: '+resp.statusText)
    return await resp.json()
}
async function ghDownload(owner, repo, path, token){
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`
    const resp = await fetch(url, { headers:{ Authorization: 'token '+token, Accept:'application/vnd.github.v3+json' }})
    if(!resp.ok) throw new Error('ä¸‹è½½å¤±è´¥: '+resp.statusText)
    const j = await resp.json()
    const content = decodeURIComponent(escape(atob(j.content.replace(/\n/g,''))))
    return { content, sha: j.sha }
}

/* GitHub æ“ä½œç»‘å®š */
btnGhUpload.addEventListener('click', async ()=>{
    const token = ghTokenInput.value.trim(); const owner = ghOwnerInput.value.trim(); const repo = ghRepoInput.value.trim(); const path = ghPathInput.value.trim()
    if(!token||!owner||!repo||!path) return alert('è¯·å®Œæ•´å¡«å†™ GitHub é…ç½®ï¼ˆå« Tokenï¼‰')
    showLoader()
    try{
        saveGhToken(token)
        const res = await ghUpload(owner, repo, path, token, JSON.stringify(db, null, 2), 'åŒæ­¥ rent data')
        alert('âœ… ä¸Šä¼ æˆåŠŸ: '+(res.content && res.content.path))
    }catch(err){ alert('âŒ ä¸Šä¼ å¤±è´¥: '+err.message) }
    finally { hideLoader() }
})
btnGhDownload.addEventListener('click', async ()=>{
    const token = ghTokenInput.value.trim(); const owner = ghOwnerInput.value.trim(); const repo = ghRepoInput.value.trim(); const path = ghPathInput.value.trim()
    if(!token||!owner||!repo||!path) return alert('è¯·å®Œæ•´å¡«å†™ GitHub é…ç½®ï¼ˆå« Tokenï¼‰')
    showLoader()
    try{
        const res = await ghDownload(owner, repo, path, token)
        const j = JSON.parse(res.content)
        if(!j.customers || !j.records) return alert('GitHub æ–‡ä»¶ç»“æ„ä¸æ­£ç¡®')
        db = j; saveDB(db); refreshCustomerList(); alert('âœ… ä¸‹è½½å¹¶è¦†ç›–æˆåŠŸï¼ˆæœ¬åœ°æ•°æ®å·²æ›´æ–°ï¼‰'); buildTable()
    }catch(err){ alert('âŒ ä¸‹è½½å¤±è´¥: '+err.message) }
    finally { hideLoader() }
})

/* å¯¼å…¥/å¯¼å‡º JSONï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰ */
btnExportJson.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href = url; a.download = 'rent-data-export.json'; a.click(); URL.revokeObjectURL(url)
    alert('âœ… JSON å¯¼å‡ºæˆåŠŸ')
})
btnImportJson.addEventListener('click', ()=> fileInput.click())
fileInput.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return
    const reader = new FileReader()
    reader.onload = function(){ try{ const j=JSON.parse(reader.result); if(!j.customers||!j.records) return alert('æ–‡ä»¶ç»“æ„ä¸æ­£ç¡®'); db=j; saveDB(db); refreshCustomerList(); alert('âœ… å¯¼å…¥å®Œæˆ'); buildTable() }catch(err){ alert('âŒ å¯¼å…¥å¤±è´¥:'+err.message) } }
    reader.readAsText(f)
})

/* Export Excel: integer yuan only, filter amount>0 */
btnExportXlsx.addEventListener('click', ()=>{
    const customer = customerSelect.value, ym = yearmonthInput.value
    if(!customer||!ym) return alert('è¯·é€‰æ‹©å®¢æˆ·ä¸æœˆä»½')
    const rows = tableContainer.querySelectorAll('tbody tr')
    const ws_data = []
    ws_data.push(['åºå·','é¡¹ç›®','æœ¬æœˆè¡¨æ•°','ä¸Šæœˆè¡¨æ•°','å®ç”¨','å•ä»·(å…ƒ)','é‡‘é¢(å…ƒ)'])
    let cnt=0, total=0
    rows.forEach(tr=>{
        const name = tr.querySelector('[data-field=name]').value
        const cur = tr.querySelector('[data-field=cur]').value
        const prev = tr.querySelector('[data-field=prev]').value
        const usage = tr.querySelector('[data-field=usage]').value
        const unitPrice = tr.querySelector('[data-field=unitPrice]').value
        const amount = toNumberOrNaN(tr.querySelector('[data-field=amount]').value)
        if(isNaN(amount) || amount<=0) return
        cnt++ ; total += integerPart(amount)
        ws_data.push([cnt, name, cur, prev, usage, unitPrice, integerPart(amount)])
    })
    if(cnt===0) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„é‡‘é¢è¡Œ')
    ws_data.push([]); ws_data.push(['åˆè®¡äººæ°‘å¸', `${total}å…ƒ`])
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, `${customer}-${ym}`)
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'}); const blob = new Blob([wbout], {type:'application/octet-stream'})
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${customer}-${ym}.xlsx`; a.click(); URL.revokeObjectURL(url)
})

/* Export JPG 1920x1440 (4:3): build template HTML, filter rows with amount<=0 */
btnExportJpg.addEventListener('click', async ()=>{
    const customer = customerSelect.value, ym = yearmonthInput.value
    if(!customer||!ym) return alert('è¯·é€‰æ‹©å®¢æˆ·ä¸æœˆä»½')
    const rows = tableContainer.querySelectorAll('tbody tr')
    const items = []
    let total = 0
    rows.forEach((tr,idx)=>{
        const name = tr.querySelector('[data-field=name]').value
        const cur = tr.querySelector('[data-field=cur]').value
        const prev = tr.querySelector('[data-field=prev]').value
        const usage = tr.querySelector('[data-field=usage]').value
        const unitPrice = tr.querySelector('[data-field=unitPrice]').value
        const amount = toNumberOrNaN(tr.querySelector('[data-field=amount]').value)
        if(isNaN(amount) || amount<=0) return
        const intAmt = integerPart(amount)
        total += intAmt
        items.push({ name, cur, prev, usage, unitPrice, amount: intAmt })
    })
    if(items.length===0) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„é‡‘é¢è¡Œ')
    const html = buildExportTemplateHtml(customer, items, total)
    // put into printArea sized 1920x1440 (4:3 ratio)
    printArea.innerHTML = html
    printArea.style.display = 'block'
    // set to 4:3 aspect ratio
    printArea.style.width = '1920px'; printArea.style.height = '1440px'; printArea.style.padding = '20px'; printArea.style.boxSizing='border-box'
    showLoader()
    try{
        const canvas = await html2canvas(printArea, { scale:1, useCORS:true, backgroundColor: '#ffffff' })
        const dataUrl = canvas.toDataURL('image/jpeg', 0.95)
        const a = document.createElement('a'); a.href = dataUrl; a.download = `${customer}-${(new Date()).toISOString().slice(0,10)}.jpg`; a.click()
    }catch(err){
        alert('âŒ å¯¼å‡º JPG å¤±è´¥: '+err.message)
    } finally {
        printArea.style.display = 'none'; printArea.innerHTML = ''
        hideLoader()
    }
})

/* æ„é€ å¯¼å‡º HTMLï¼ˆæ”¯æŒæ‰‹åŠ¨è®¾ç½®åˆ—å®½ï¼‰ */
function buildExportTemplateHtml(customer, items, total){
    const FONT_SCALE = 1.2;

    /* â˜…â˜… ä¿®æ”¹è¿™é‡Œå³å¯æ§åˆ¶åˆ—å®½ â˜…â˜… */
    const COL_W = {
    idx: "80px",
    name: "300px",
    cur: "160px",
    prev: "160px",
    usage: "120px",
    price: "120px",
    amount: "260px"
};
    let rowsHtml = '';
    items.forEach((it, idx)=>{
        rowsHtml += `
        <tr>
            <td style="width:${COL_W.idx}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${idx+1}</td>
            <td style="width:${COL_W.name}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(it.name)}</td>
            <td style="width:${COL_W.cur}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(it.cur)}</td>
            <td style="width:${COL_W.prev}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(it.prev)}</td>
            <td style="width:${COL_W.usage}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(it.usage)}</td>
            <td style="width:${COL_W.price}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(it.unitPrice)}</td>
            <td style="width:${COL_W.amount}; font-size:${28*FONT_SCALE}px; padding:20px 10px;">${escapeHtml(String(it.amount))}</td>
        </tr>`
    });

    const todayStr = formatYMD(new Date());

    return `
    <div class="export-template" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#ffffff">
    <table class="tg"
   style="width:100%; border: 2px solid #000; border-collapse: collapse;">
    <thead>
        <tr>
            <th colspan="7" style="font-size:${40*FONT_SCALE}px;padding:25px 20px;">æˆ¿å±‹å‡ºç§Ÿæ”¶è´¹å•</th>
        </tr>
    </thead>
    <tbody>

        <tr>
            <td colspan="2" style="font-size:${28*FONT_SCALE}px;padding:20px 15px;">å®¢æˆ·ï¼š</td>
            <td colspan="5" style="font-size:${28*FONT_SCALE}px;padding:20px 15px;">${escapeHtml(customer)}</td>
        </tr>

        <tr style="background:#f8f9fa">
            <td style="width:${COL_W.idx}; font-size:${26*FONT_SCALE}px;">åºå·</td>
            <td style="width:${COL_W.name}; font-size:${26*FONT_SCALE}px;">é¡¹ç›®</td>
            <td style="width:${COL_W.cur}; font-size:${26*FONT_SCALE}px;">æœ¬æœˆè¡¨æ•°</td>
            <td style="width:${COL_W.prev}; font-size:${26*FONT_SCALE}px;">ä¸Šæœˆè¡¨æ•°</td>
            <td style="width:${COL_W.usage}; font-size:${26*FONT_SCALE}px;">å®ç”¨</td>
            <td style="width:${COL_W.price}; font-size:${26*FONT_SCALE}px;">å•ä»·(å…ƒ)</td>
            <td style="width:${COL_W.amount}; font-size:${26*FONT_SCALE}px;">é‡‘é¢(å…ƒ)</td>
        </tr>
    </tbody>

<tbody>
    ${rowsHtml}

    <tr style="background:#ebebeb; font-weight:700;">
        <td colspan="2" style="font-size:${28*FONT_SCALE}px;padding:20px 15px;">åˆè®¡äººæ°‘å¸</td>
        <td colspan="5" style="font-size:${32*FONT_SCALE}px;padding:20px 15px;">${total}å…ƒ</td>
    </tr>
</tbody>

    <tbody>
        <tr>
            <td colspan="2" style="font-size:${26*FONT_SCALE}px;padding:18px 12px;">å¡«å†™æ—¥æœŸï¼š</td>
            <td colspan="2" style="font-size:${26*FONT_SCALE}px;padding:18px 12px;">${todayStr}</td>
            <td colspan="3" style="font-size:${26*FONT_SCALE}px;padding:18px 12px;">å¡«å†™äººï¼šç¾Š</td>
        </tr>

    </tbody>
    </table>
    </div>`;
}

// ================== æœˆä»½åˆ‡æ¢ç›¸å…³å‡½æ•° ==================

/* ä¿®å¤çš„æœˆä»½åˆ‡æ¢é€»è¾‘ */
function switchToMonth(ym) {
  const customer = customerSelect.value;
  if (!customer) {
    alert('è¯·å…ˆé€‰æ‹©å®¢æˆ·');
    return;
  }
  
  const currentYm = yearmonthInput.value;
  
  // âœ… è‡ªåŠ¨ä¿å­˜å½“å‰æœˆä»½æ•°æ®ï¼ˆå¦‚æœå½“å‰æœˆä»½æœ‰æ•°æ®ï¼‰
  const currentItems = readItemsFromUI();
  if (currentItems.length > 0 && hasDataChanges(currentItems)) {
    console.log(`ğŸ’¾ è‡ªåŠ¨ä¿å­˜ ${currentYm} æœˆæ•°æ®`);
    saveCurrentMonth();
  }

  console.log(`ğŸ”„ åˆ‡æ¢åˆ°æœˆä»½: ${ym}, å®¢æˆ·: ${customer}`);
  
  // æ›´æ–°æœˆä»½è¾“å…¥æ¡†
  yearmonthInput.value = ym;
  
  // é‡æ–°æ„å»ºè¡¨æ ¼
  buildTable();
  
  // æ›´æ–°æœˆä»½æ˜¾ç¤º
  const currentMonthDisplay = document.getElementById('currentMonthDisplay');
  if (currentMonthDisplay) {
    currentMonthDisplay.textContent = ym;
  }
  
  // æ˜¾ç¤ºæœˆä»½åˆ‡æ¢æç¤º
  showMonthSwitchMessage(ym);
}

/* æœˆä»½åˆ‡æ¢æç¤º */
function showMonthSwitchMessage(newMonth) {
  const lastMonth = prevMonth(newMonth);
  const hasLastMonthData = db.records[monthKey(customerSelect.value, lastMonth)];
  
  let message = `å·²åˆ‡æ¢åˆ° ${newMonth} æœˆ`;
  
  if (hasLastMonthData) {
    message += `\nâ€¢ å·²ä» ${lastMonth} æœˆç»§æ‰¿æ•°æ®`;
    message += `\nâ€¢ ç”¨é‡é¡¹ç›®çš„"ä¸Šæœˆè¡¨æ•°"å·²è‡ªåŠ¨å¡«å†™`;
    message += `\nâ€¢ è¯·å¡«å†™æœ¬æœˆçš„"æœ¬æœˆè¡¨æ•°"`;
  } else {
    message += `\nâ€¢ è¿™æ˜¯ä¸€ä¸ªæ–°çš„è®¡è´¹å‘¨æœŸ`;
    message += `\nâ€¢ è¯·å¡«å†™æ‰€æœ‰é¡¹ç›®çš„åˆå§‹æ•°æ®`;
  }
  
  showToast(message, 'info', 5000);
}

/* æ”¹è¿›çš„ä¿å­˜é€»è¾‘ */
function saveCurrentMonth() {
  const customer = customerSelect.value;
  const ym = yearmonthInput.value;
  
  if (!customer || !ym) return;
  
  const items = readItemsFromUI();
  const key = monthKey(customer, ym);
  
  // éªŒè¯æ•°æ®å®Œæ•´æ€§
  const validation = validateMonthData(items, ym);
  if (!validation.isValid) {
    alert(`æ•°æ®ä¸å®Œæ•´ï¼š\n${validation.errors.join('\n')}`);
    return;
  }
  
  db.records[key] = {
    meta: {
      savedAt: new Date().toISOString(),
      customer: customer,
      yearmonth: ym,
      total: calcTotal()
    },
    items: items
  };
  
  // æ›´æ–°æ¨¡æ¿ç»“æ„
  db.customers[customer].template = getTemplateFromUI();
  saveDB(db);
  showToast(`${ym} æœˆæ•°æ®å·²ä¿å­˜`, 'success');
  
  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  updateMonthStatus(customer, ym);
}

/* äº‹ä»¶ï¼šåˆ‡æ¢æœˆä»½/å®¢æˆ· */
// æ›¿æ¢åŸæœ‰çš„æ–°å»ºæœˆä»½æŒ‰é’®äº‹ä»¶
btnNewMonth.removeEventListener('click', buildTable);
btnNewMonth.addEventListener('click', () => {
  const newMonth = prompt('è¯·è¾“å…¥è¦åˆ‡æ¢çš„å¹´æœˆï¼ˆæ ¼å¼ï¼šYYYY-MMï¼‰ï¼š', yearmonthInput.value);
  if (newMonth && /^\d{4}-\d{2}$/.test(newMonth)) {
    switchToMonth(newMonth);
  }
});

customerSelect.addEventListener('change', buildTable)
yearmonthInput.addEventListener('change', buildTable)

// æœˆä»½å¯¼èˆªäº‹ä»¶ï¼ˆå¦‚æœæœˆä»½å¯¼èˆªæŒ‰é’®å·²æ·»åŠ åˆ°HTMLä¸­ï¼‰
document.getElementById('btnPrevMonth')?.addEventListener('click', () => {
  const current = yearmonthInput.value;
  const prev = prevMonth(current);
  switchToMonth(prev);
});

document.getElementById('btnNextMonth')?.addEventListener('click', () => {
  const current = yearmonthInput.value;
  const next = nextMonth(current);
  switchToMonth(next);
});

/* æ·»åŠ æ¸…ç†ç©ºæœˆä»½æ•°æ®çš„åŠŸèƒ½ */
function cleanupEmptyMonthData() {
  console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ç©ºæ•°æ®æœˆä»½...');
  let cleanedCount = 0;
  
  Object.keys(db.records).forEach(key => {
    const record = db.records[key];
    if (record && record.items) {
      const hasRealData = record.items.some(item => {
        if (item.type === 'usage') {
          return item.cur !== '' || item.prev !== '';
        } else {
          return item.fixedAmount > 0;
        }
      });
      
      if (!hasRealData) {
        console.log(`ğŸ—‘ï¸ æ¸…ç†ç©ºæ•°æ®æœˆä»½: ${key}`);
        delete db.records[key];
        cleanedCount++;
      }
    }
  });
  
  if (cleanedCount > 0) {
    saveDB(db);
    console.log(`âœ… å·²æ¸…ç† ${cleanedCount} ä¸ªç©ºæ•°æ®æœˆä»½`);
  } else {
    console.log('âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„ç©ºæ•°æ®æœˆä»½');
  }
  
  return cleanedCount;
}

/* è‡ªåŠ¨åŠ è½½å½“å‰æœˆè¡¨å•ï¼ˆé¡µé¢æ‰“å¼€è‡ªåŠ¨åˆ‡æ¢åˆ°å½“å‰æœˆï¼‰ */
window.addEventListener('load', ()=> {
    // set default customer selection to first
    if(customerSelect.options.length>0) customerSelect.selectedIndex = 0
    // ensure yearmonth is current month
    yearmonthInput.value = new Date().toISOString().slice(0,7)
    buildTable()
    // load saved token if any into input
    const savedToken = loadGhToken()
    if(savedToken) ghTokenInput.value = savedToken
    
    // åˆå§‹åŒ–æœˆä»½çŠ¶æ€æ˜¾ç¤º
    updateMonthStatus(customerSelect.value, yearmonthInput.value);
    
    // æ›´æ–°æœˆä»½æ˜¾ç¤º
    const currentMonthDisplay = document.getElementById('currentMonthDisplay');
    if (currentMonthDisplay) {
        currentMonthDisplay.textContent = yearmonthInput.value;
    } // âœ… ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„é—­åˆå¤§æ‹¬å·

    // æ¸…ç†ç©ºæ•°æ®æœˆä»½
    cleanupEmptyMonthData();
}); // âœ… ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„é—­åˆæ‹¬å·

/* è¾…åŠ© */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;') }

// æ£€æµ‹è®¾å¤‡ç±»å‹
function detectDevice() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.body.classList.add('mobile-device');
    } else {
        document.body.classList.add('desktop-device');
    }
}

// åˆå§‹åŒ–è®¾å¤‡æ£€æµ‹
detectDevice();

/* ç»“æŸ */
</script>

</body>
</html>
